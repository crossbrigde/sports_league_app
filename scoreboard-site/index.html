<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>æ­¦è¡“ç«¶è³½è¨˜åˆ†æ¿</title>

  <!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-database-compat.js"></script>
  <script>
    // åˆå§‹åŒ–Firebaseé…ç½®
    const firebaseConfig = {
    projectId: "sports-league-app-d25e2",
    databaseURL: "https://sports-league-app-d25e2-default-rtdb.asia-southeast1.firebasedatabase.app"
  };
  firebase.initializeApp(firebaseConfig);
  </script>

  <!-- å­—å‹ï¼šOrbitron -->
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700&display=swap" rel="stylesheet">

  <style>
body {
  margin: 0;
  background-color: #ECEFF1;
  font-family: 'Orbitron', sans-serif;
  color: white;
}

#matchContainer {
  max-width: 800px;
  margin: 20px auto;
  padding: 20px;
  
}

.match-button {
  width: 100%;
  margin: 10px 0;
  padding: 15px;
  background: white;
  border: 1px solid #ddd;
  border-radius: 8px;
  text-align: left;
  cursor: pointer;
  transition: all 0.3s;
  color: black;
}

.match-button:hover {
  background: #f5f5f5;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.match-title {
  font-size: 18px;
  font-weight: bold;
  margin-bottom: 8px;
  
}

.match-details {
  color: #666;
  font-size: 14px;
  
  
}

/* âœ… è¨˜åˆ†æ¿ */
.scoreboard {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100vh;
  display: flex;
  flex-direction: column; /* ğŸŸ¢ åŠ é€™è¡Œ */
  background: black;
}

.fullscreen-btn {
  position: absolute;
  top: 10px;
  right: 10px;
  background: #444;
  color: white;
  padding: 10px 20px;
  border: none;
  border-radius: 8px;
  font-size: 16px;
  cursor: pointer;
  z-index: 10;
}

.round {
  font-size: 2vw;
  color: #bbb;
  margin-top: 20px;
  text-align: center; /* â† åŠ é€™ä¸€è¡Œå°±èƒ½è®“æ–‡å­—ç½®ä¸­ */
  
}

.score-display {
  flex: 1;
  display: flex;
  flex-direction: row;
  width: 100%;
  align-items: stretch;
}

/* ğŸŸ¥ ç´…æ–¹ / ğŸŸ¦ è—æ–¹ */
.score-block {
  flex: 1;
  height: 100%;
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  position: relative;
  padding: 10px;
  box-sizing: border-box;
}

.red-block {
  background-color: #ff3b30;
}

.blue-block {
  background-color: #007aff;
}

.score-label {
  font-size: 2.5vw;
  margin-bottom: 20px;
}

.score-wrapper {
  position: relative;
  display: inline-block;
}

.score-value {
  font-size: 20vw;
  font-weight: bold;
  line-height: 1;
  z-index: 1;
}

/* ğŸ†• æµ®å‹•çš„è‡¨æ™‚å¾—åˆ† (+1, +2...) */
.temp-score {
  position: fixed; /* â† ç›´æ¥ç›¸å°æ•´å€‹ç•«é¢ */
  top: 42vh;        /* è·é›¢ç•«é¢ä¸Šæ–¹ 42% é«˜åº¦ */
  font-size: 6vw;
  font-weight: bold;
  color: rgba(255, 255, 255, 0.95);
  text-shadow: 2px 2px 6px rgba(0, 0, 0, 0.4);
  z-index: 9999;
  pointer-events: none;
  transform: translate(-50%, -50%);
}

/* æ­£æ•¸å€¼é¡¯ç¤ºç‚ºç¶ è‰² */
.temp-score-positive {
  color: rgba(0, 255, 0, 0.95);
}

/* è² æ•¸å€¼é¡¯ç¤ºç‚ºç´…è‰² */
.temp-score-negative {
  color: rgba(255, 0, 0, 0.95);
}

/* ç´…æ–¹ â†’ åå·¦ä¸€é» */
#redTempScore {
  left: 45vw;
}

/* è—æ–¹ â†’ åå³ä¸€é» */
#blueTempScore {
  left: 55vw;
}

.last-hit {
  padding: 20px;
  font-size: 1.8vw;
  color: #ccc;
  text-align: center;
  background-color: #111;
  width: 100%;
  box-sizing: border-box;
  flex-shrink: 0; /* ğŸŸ¢ é˜²æ­¢å®ƒè¢«å£“ç¸® */
}
  </style>
</head>
<body>

  <div id="matchContainer">
    <h1>é€²è¡Œä¸­çš„æ¯”è³½</h1>
    <div id="matchList" class="loading">è¼‰å…¥æ¯”è³½ä¸­...</div>

    <div id="scoreboard" class="scoreboard" style="display: none;">
      <button class="fullscreen-btn" onclick="toggleFullscreen()">å…¨è¢å¹•</button>

      <div class="round" id="matchName"></div>

        <div class="score-display" style="position: relative;">
    
        <div class="score-block red-block">
          <div class="score-label" id="redPlayer">ç´…æ–¹</div>
          <div class="score-wrapper">
            <div class="score-value" id="redScore">0</div>

         </div>
        </div>
        <div class="score-block blue-block">
          <div class="score-label" id="bluePlayer">è—æ–¹</div>
          <div class="score-wrapper">
            <div class="score-value" id="blueScore">0</div>
          </div>
       </div>
      </div>


      <div class="last-hit" id="lastHit">ç­‰å¾…è¨˜åˆ†...</div>
    </div>
    <div class="temp-score" id="redTempScore"></div>
    <div class="temp-score" id="blueTempScore"></div>
  </div>

  <script>
    function toggleFullscreen() {
      const el = document.documentElement;
      if (!document.fullscreenElement) {
        el.requestFullscreen().catch(err => alert(`ç„¡æ³•é€²å…¥å…¨è¢å¹•: ${err.message}`));
      } else {
        document.exitFullscreen();
      }
    }

    document.addEventListener('DOMContentLoaded', function () {
      const matchList = document.getElementById('matchList');
      const scoreboard = document.getElementById('scoreboard');

      try {
        firebase.app().firestore().collection('matches')
          .where('basic_info.status', '==', 'ongoing')
          .onSnapshot((snapshot) => {
            if (snapshot.empty) {
              matchList.innerHTML = '<div class="loading">ç›®å‰æ²’æœ‰é€²è¡Œä¸­çš„æ¯”è³½</div>';
              return;
            }

            matchList.innerHTML = '';
            snapshot.forEach((doc) => {
              const match = doc.data().basic_info;
              const button = document.createElement('button');
              button.className = 'match-button';
              button.innerHTML = `
                <div class="match-title">${match.tournamentName}</div>
                <div class="match-details">
                  æ¯”è³½å ´æ¬¡: ${match.matchNumber}<br>
                  ç´…æ–¹: ${match.redPlayer} vs è—æ–¹: ${match.bluePlayer}
                </div>
              `;
              button.onclick = () => showScoreboard(doc.id);
              matchList.appendChild(button);
            });
          });

        function showScoreboard(matchId) {
          matchList.style.display = 'none';
          document.querySelector('h1').style.display = 'none';

          firebase.app().firestore().collection('matches')
            .doc(matchId)
            .onSnapshot((doc) => {
              const data = doc.data();
              const match = data.basic_info;
              const scores = data.scores;
              const judgments = data.judgments;            

              document.getElementById('redPlayer').textContent = `ç´…æ–¹ - ${match.redPlayer}`;
              document.getElementById('bluePlayer').textContent = `è—æ–¹ - ${match.bluePlayer}`;
              document.getElementById('redScore').textContent = scores?.redScores?.total ?? 0;
              document.getElementById('blueScore').textContent = scores?.blueScores?.total ?? 0;
              document.getElementById('matchName').textContent = match.name;

              let hitInfo = 'ç­‰å¾…è¨˜åˆ†...';

                if (judgments && judgments.length > 0) {
                 const lastJudgment = judgments[judgments.length - 1];
                 const parts = [];

                if (lastJudgment.redPoints > 0) {
                 const redHits = [];
                 const hits = lastJudgment.redHitLocations || {};
                 if (hits.leftLeg) redHits.push('å·¦è…³');
                 if (hits.rightLeg) redHits.push('å³è…³');
                 if (hits.leftArm) redHits.push('å·¦æ‰‹');
                 if (hits.rightArm) redHits.push('å³æ‰‹');
                 if (hits.body) redHits.push('è»€å¹¹');
                 if (hits.head) redHits.push('é ­éƒ¨');
                 parts.push(`ç´…æ–¹æ“Šä¸­è—æ–¹${redHits.join('ã€')}å¾—${lastJudgment.redPoints}åˆ†`);
  }

            if (lastJudgment.bluePoints > 0) {
             const blueHits = [];
             const hits = lastJudgment.blueHitLocations || {};
                 if (hits.leftLeg) blueHits.push('å·¦è…³');
                 if (hits.rightLeg) blueHits.push('å³è…³');
                 if (hits.leftArm) blueHits.push('å·¦æ‰‹');
                 if (hits.rightArm) blueHits.push('å³æ‰‹');
                 if (hits.body) blueHits.push('è»€å¹¹');
                 if (hits.head) blueHits.push('é ­éƒ¨');
                 parts.push(`è—æ–¹æ“Šä¸­ç´…æ–¹${blueHits.join('ã€')}å¾—${lastJudgment.bluePoints}åˆ†`);
  }

             if (parts.length > 0) {
               hitInfo = parts.join('ï½œ');  // ä¸­é–“ç”¨ã€Œï½œã€åˆ†éš”å…©é‚Šçµæœ
  }
}

              document.getElementById('lastHit').textContent = hitInfo;
              scoreboard.style.display = 'flex';
            });

          // ç›£è½è‡¨æ™‚å¾—åˆ†è®ŠåŒ–
          const tempScoresRef = firebase.app().database().ref(`temp_scores/${matchId}`);
          console.log('ç›£è½Realtime Databaseè·¯å¾‘:', `temp_scores/${matchId}`);
          tempScoresRef.on('value', (snapshot) => {
            console.log('æ”¶åˆ°Realtime Databaseæ›´æ–°:', snapshot.val());
            const tempScores = snapshot.val() || {};
            console.log('è™•ç†å¾Œçš„è‡¨æ™‚å¾—åˆ†:', tempScores);
            const redTemp = Object.values(tempScores.red_temp || {}).reduce((sum, score) => sum + score, 0);
            const blueTemp = Object.values(tempScores.blue_temp || {}).reduce((sum, score) => sum + score, 0);
            console.log('è¨ˆç®—å¾Œçš„è‡¨æ™‚å¾—åˆ† - ç´…æ–¹:', redTemp, 'è—æ–¹:', blueTemp);
            // ä¿®æ”¹é¡¯ç¤ºé‚è¼¯ï¼Œæ”¯æŒè² æ•¸å€¼
            const redTempEl = document.getElementById('redTempScore');
            const blueTempEl = document.getElementById('blueTempScore');
            
            // è¨­ç½®ç´…æ–¹è‡¨æ™‚å¾—åˆ†
            redTempEl.textContent = redTemp > 0 ? `+${redTemp}` : (redTemp < 0 ? `${redTemp}` : '');
            redTempEl.className = 'temp-score';
            if (redTemp > 0) redTempEl.classList.add('temp-score-positive');
            if (redTemp < 0) redTempEl.classList.add('temp-score-negative');
            
            // è¨­ç½®è—æ–¹è‡¨æ™‚å¾—åˆ†
            blueTempEl.textContent = blueTemp > 0 ? `+${blueTemp}` : (blueTemp < 0 ? `${blueTemp}` : '');
            blueTempEl.className = 'temp-score';
            if (blueTemp > 0) blueTempEl.classList.add('temp-score-positive');
            if (blueTemp < 0) blueTempEl.classList.add('temp-score-negative');
          });
        }
      } catch (e) {
        console.error(e);
        matchList.innerHTML = '<div class="loading">è¼‰å…¥å¤±æ•—</div>';
      }
    });
  </script>
</body>
</html>